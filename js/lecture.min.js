$(function(){$(".transfert button.icon-ok").on("click",function(e){e.preventDefault(),$.ajax({url:"ajax.php",method:"post",data:"verifconnexion=1",dataType:"json",el:$(this),fonction:function(e){var t=e.parent().parent(),n=new FormData(t[0]);n.append("id",t.parent().data("id")),$.ajax({url:"ajax.php",xhr:function(){var t,s,n=$.ajaxSettings.xhr();return $("#log").hide(0),n.upload&&e.prev()[0].files.length>0&&($("#load").html('<p>Transfert en cours<span></span></p><img src="js/ajax-loader.gif">'),s=$("#load p").css("background"),t=0,n.upload.addEventListener("progress",function(e){e.lengthComputable&&(t=Math.round(e.loaded/e.total*100),$("#load span").html(" - "+t+"%"),$("#load p").css("background",s.replace(/0%/g,t+"%")))},!1)),n},method:"post",data:n,dataType:"json",contentType:!1,processData:!1})}})}),$(".transfert a span").parent().css("cursor","pointer").on("click",function(){$(this).siblings(".icon-download").click()}),$(".transfert a.icon-download").on("click",function(){$.ajax({url:"ajax.php",method:"post",data:"verifconnexion=1",dataType:"json",el:$(this).parent(),fonction:function(e){$("#log").hide(0),window.location.href="transferts.php?dl="+e.data("id")+"&t="+e.parent().data("id")+"&verif="+e.data("verif")}})}),$(".transfert a.icon-supprime").on("click",function(){var e=$(this).parent();popup(`<h3>Demande de confirmation</h3><p>Vous allez supprimer un document que vous avez envoyé. Vos professeurs/colleurs qui pouvaient le voir ne pourront plus le récupérer après cela. Cette action n'est pas annulable.</p><p class="confirmation"><button class="icon-ok"></button>&nbsp;&nbsp;&nbsp;<button class="icon-annule"></button></p>`,!0),$("#fenetre .icon-ok").on("click",function(){$.ajax({url:"ajax.php",method:"post",data:{action:"suppr-transdocs",id:e.data("id"),transfert:e.parent().data("id")},dataType:"json",el:e,fonction:function(e){e.remove()}}),$("#fenetre,#fenetre_fond").remove()}),$("#fenetre .icon-annule").on("click",function(){$("#fenetre,#fenetre_fond").remove()})}),$("#parentsdoc a.icon-downloadrep").on("click",function(){$("#epingle").remove(),$(`<article id="epingle"><a class="icon-ferme" title="Fermer"></a><a class="icon-download" title="Valider"></a>       <h3 class="edition">Télécharger le contenu d'un répertoire</h3>       <form><table><thead><tr><th>Nom</th><th class="icones"><a class="icon-cocher" title="Tout cocher"></a></th></tr></thead><tbody></tbody></table>       </form></article>`).prependTo($("section")).append($("#aide-download").html());var e=$("#epingle table");$("section > p[data-id]").each(function(){var t=$(this);t.hasClass("rep")?e.append('<tr><td><span class="icon-rep"></span>&nbsp;'+t.find("span.nom").text()+'</td><td class="icones"><input type="checkbox" name="reps[]" value="'+t.data("id")+'"></td></tr>'):e.append('<tr><td><span class="icon-doc"></span>&nbsp;'+t.find("span.nom").text()+'</td><td class="icones"><input type="checkbox" name="docs[]" value="'+t.data("id")+'"></td></tr>')}),$("#iconesmenu .icon-connexion").length&&$("#epingle form").append('<input type="hidden" name="auto0" value="1">'),$("input",e).on("change",function(){$(this).parent().parent().toggleClass("sel",this.checked)}),$(".icon-cocher",e).on("click",function(){$(this).toggleClass("icon-cocher icon-decocher"),$("input",e).prop("checked",$(this).hasClass("icon-decocher")).change()}),$("tr",e).find("td:not(:last-child)").on("click",function(){$(this).parent().find("input").click().change()}),$("#epingle .icon-ferme").on("click",function(){$("#epingle").remove()}),$("#epingle .icon-download").on("click",function(){if($("input:checked",e).length==0){affiche("<p>Aucune case n'est cochée.</p>","nok");return}$("body").data("async",!0),affiche("Récupération de la liste des documents","ok");var t=$("#parentsdoc a.icon-downloadrep").data("id");$.ajax({url:"recup.php",method:"post",data:"action=download-rep&id="+t+"&"+$("#epingle form").serialize(),dataType:"json",afficheform:async function(e){var n,s,o,a,r,c,l,i=e.dids.split(","),d=e.verifs.split(","),u=e.taille;if(i.length){$("#log").hide(0),$("#load").html('<p>Téléchargement en cours<span></span></p><img src="js/ajax-loader.gif">').show(0),a=[],r=0;try{for(c=$("#load p").css("background"),o=0,n=0;n<i.length;n++)a[n]=await fetch("download?zip&r="+t+"&d="+i[n]+"&verif="+d[n]).then(async function(e){for(n=e.body.getReader(),t=[];!0;){var{done:i,value:s}=await n.read(),t,n;if(i)break;t.push(s),r+=s.length,o=Math.min(100,Math.round(r/u*100)),$("#load span").html(" - "+o+"%"),$("#load p").css("background",c.replace(/0%/g,o+"%"))}if(e.headers.get("Content-Length")==="0")return;return{name:decodeURIComponent(e.headers.get("Content-Disposition").split('="')[1]).slice(0,-1),input:new Blob(t)}});$("#load span").html(" - 100%"),$("#load p").css("background",c.replace(/0%/g,"100%")),l=await downloadZip(a).blob(),s=document.createElement("a"),s.href=URL.createObjectURL(l),s.download=e.nom+".zip",$("#load").fadeOut(),$("body").data("async",!1),s.click(),URL.revokeObjectURL(s.href)}catch(e){affiche("Il y a eu une erreur pendant le téléchargement. Vous devriez prévenir l'administrateur. Le message d'erreur est « "+e.message+" »","nok"),$("#load").fadeOut(),$("body").data("async",!1)}}else affiche("Il n'y a rien à télécharger par ici.","nok"),$("#load").fadeOut(),$("body").data("async",!1)}})}),$("#epingle").deplace_viewport()})})